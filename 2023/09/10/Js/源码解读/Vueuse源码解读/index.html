<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Vueuse源码解读 - Liang的个人博客</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Liang Blog"><meta name="msapplication-TileImage" content="/img/avatar.jpg"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Liang Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="144x144" href="/img/avatar.jpg"><meta name="description" content="本文不会放api的用法，建议先看看是怎么用的 写本篇文章时间间隔较长，所以代码版本不一  项目架构采用monorepo的形式，项目目录下有多个子项目，下面放了资料链接和几处用法，其他本文不多赘述。 现代前端工程为什么越来越离不开 Monorepo?为什么使用pnpm可以光速建立好用的monorepo（比yarn&amp;#x2F;lerna效率高）pnpm workspace文档"><meta property="og:type" content="blog"><meta property="og:title" content="Vueuse源码解读"><meta property="og:url" content="https://liang5757.github.io/2023/09/10/Js/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Vueuse%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"><meta property="og:site_name" content="Liang的个人博客"><meta property="og:description" content="本文不会放api的用法，建议先看看是怎么用的 写本篇文章时间间隔较长，所以代码版本不一  项目架构采用monorepo的形式，项目目录下有多个子项目，下面放了资料链接和几处用法，其他本文不多赘述。 现代前端工程为什么越来越离不开 Monorepo?为什么使用pnpm可以光速建立好用的monorepo（比yarn&amp;#x2F;lerna效率高）pnpm workspace文档"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://liang5757.github.io/img/og_image.png"><meta property="article:published_time" content="2023-09-10T08:53:55.000Z"><meta property="article:modified_time" content="2023-09-10T08:54:37.043Z"><meta property="article:author" content="Liang"><meta property="article:tag" content="js"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://liang5757.github.io/2023/09/10/Js/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Vueuse%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"},"headline":"Vueuse源码解读","image":["https://liang5757.github.io/img/og_image.png"],"datePublished":"2023-09-10T08:53:55.000Z","dateModified":"2023-09-10T08:54:37.043Z","author":{"@type":"Person","name":"Liang"},"publisher":{"@type":"Organization","name":"Liang的个人博客","logo":{"@type":"ImageObject","url":"https://liang5757.github.io/2023/09/10/Js/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Vueuse%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"}},"description":"本文不会放api的用法，建议先看看是怎么用的 写本篇文章时间间隔较长，所以代码版本不一  项目架构采用monorepo的形式，项目目录下有多个子项目，下面放了资料链接和几处用法，其他本文不多赘述。 现代前端工程为什么越来越离不开 Monorepo?为什么使用pnpm可以光速建立好用的monorepo（比yarn&#x2F;lerna效率高）pnpm workspace文档"}</script><link rel="canonical" href="https://liang5757.github.io/2023/09/10/Js/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/Vueuse%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"><link rel="icon" href="/img/avatar.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="Liang的个人博客" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Liang的个人博客</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Liang5757"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>Vueuse源码解读</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2023-09-10T08:53:55.000Z" title="2023-09-10T08:53:55.000Z">2023-09-10</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2023-09-10T08:54:37.043Z" title="2023-09-10T08:54:37.043Z">2023-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">源码解读</a></span><span class="level-item">32 分钟读完 (大约4840个字)</span></div></div><div class="content"><blockquote>
<p>本文不会放api的用法，建议先看看是怎么用的</p>
<p>写本篇文章时间间隔较长，所以代码版本不一</p>
</blockquote>
<h2 id="项目架构"><a href="#项目架构" class="headerlink" title="项目架构"></a>项目架构</h2><p>采用monorepo的形式，项目目录下有多个子项目，下面放了资料链接和几处用法，其他本文不多赘述。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6944877410827370504">现代前端工程为什么越来越离不开 Monorepo?</a><br><a target="_blank" rel="noopener" href="https://www.codeleading.com/article/46915806308/">为什么使用pnpm可以光速建立好用的monorepo（比yarn/lerna效率高）</a><br><a target="_blank" rel="noopener" href="https://pnpm.io/zh/workspaces">pnpm workspace文档</a></p>
<a id="more"></a>

<p>为了使<strong>所有子项目都使用同一个依赖版本</strong>，使用<a target="_blank" rel="noopener" href="https://pnpm.io/zh/package_json#pnpmoverrides">pnpm.overrides</a>配置，如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;pnpm&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;overrides&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;vue-demi&quot;</span>: <span class="string">&quot;0.12.1&quot;</span>, <span class="comment">// 在postinstall钩子中根据当前环境的vue版本，获取兼容vue3和vue2的api</span></span><br><span class="line">      <span class="attr">&quot;vite&quot;</span>: <span class="string">&quot;^2.6.7&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在正常配置下，如果直接<code>pnpm install</code>将会在每个子项目的<code>node_modules</code>有同样的依赖，但是所有子项目相同的依赖其实只需要提取出来放在根目录的<code>node_modules</code>下即可，可配置如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;peerDependencies&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;@vue/composition-api&quot;</span>: <span class="string">&quot;^1.1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;vue&quot;</span>: <span class="string">&quot;^2.6.0 || ^3.2.0&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>详情请看如下链接</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wonyun/p/9692476.html">探讨npm依赖管理之peerDependencies</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21567385/article/details/121088506">pnpm monorepo之多组件实例和peerDependencies困境回溯</a><br><a target="_blank" rel="noopener" href="https://pnpm.io/zh/how-peers-are-resolved">如何处理 peers</a></p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="unref-ref的反操作"><a href="#unref-ref的反操作" class="headerlink" title="unref - ref的反操作"></a>unref - ref的反操作</h3><ul>
<li>如果传入一个ref，返回其值</li>
<li>否则原样放回</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码实现</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unref</span>&lt;<span class="title">T</span>&gt;(<span class="params">ref: T | Ref&lt;T&gt;</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isRef(ref) ? ref.value : ref</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 使用例子：实现一个响应式的add函数，可以传入<strong>ref或值</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  a: Ref&lt;<span class="built_in">number</span>&gt; | <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  b: Ref&lt;<span class="built_in">number</span>&gt; | <span class="built_in">number</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computed(<span class="function">() =&gt;</span> unref(a) + unref(b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MaybeRef类型"><a href="#MaybeRef类型" class="headerlink" title="MaybeRef类型"></a>MaybeRef类型</h3><p>vueuse大量使用<code>MaybeRef</code>来支持<strong>可选择性的响应式参数</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MaybeRef&lt;T&gt; = Ref&lt;T&gt; | T</span><br></pre></td></tr></table></figure>
<p>上面的加法函数就可以简写为</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a: MaybeRef&lt;<span class="built_in">number</span>&gt;, b: MaybeRef&lt;<span class="built_in">number</span>&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computed(<span class="function">() =&gt;</span> unref(a) + unref(b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Effect作用域API"><a href="#Effect作用域API" class="headerlink" title="Effect作用域API"></a>Effect作用域API</h3><p>Vue官方文档：<a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/api/effect-scope.html#effectscope">Effect 作用域 API</a></p>
<p><strong>动机</strong></p>
<p>在Vue的setup中，响应式effect会在初始化的时候被收集，在实例被卸载的时候，响应式effect就会自动被取消了，但是在我们在组件外写一个独立的包（就如vueuse）时，我们该如何取消computed &amp; watch的响应式依赖呢？vue3.2提出了<code>effectScope</code>，接下来介绍相关的api</p>
<h4 id="effectScope"><a href="#effectScope" class="headerlink" title="effectScope"></a>effectScope</h4><p>利用<code>effectScope</code>创建一个作用域对象，如下面接口定义所示，<code>run</code>接受一个函数，这个作用域对象会自动捕获函数内部的响应式effect (例如计算属性或侦听器)</p>
<p><strong>类型</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effectScope</span>(<span class="params">detached?: <span class="built_in">boolean</span></span>): <span class="title">EffectScope</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">interface</span> <span class="title">EffectScope</span> </span>&#123;</span><br><span class="line">  run&lt;T&gt;(fn: <span class="function">() =&gt;</span> T): T | <span class="literal">undefined</span> <span class="comment">// 如果这个域不活跃则为 undefined</span></span><br><span class="line">  stop(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>示例</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> scope = effectScope()</span><br><span class="line"></span><br><span class="line">scope.run(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> doubled = computed(<span class="function">() =&gt;</span> counter.value * <span class="number">2</span>)</span><br><span class="line">  watch(doubled, <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(doubled.value))</span><br><span class="line">  watchEffect(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;Count: &#x27;</span>, doubled.value))</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 丢弃(dispose) 该作用域内的所有 effect</span></span><br><span class="line">scope.stop()</span><br></pre></td></tr></table></figure>
<h4 id="getCurrentScope"><a href="#getCurrentScope" class="headerlink" title="getCurrentScope"></a>getCurrentScope</h4><p>如果有，则返回当前活跃的 <a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/api/effect-scope.html#effectscope">effect 作用域</a>。</p>
<p><strong>类型</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCurrentScope</span>(<span class="params"></span>): <span class="title">EffectScope</span> | <span class="title">undefined</span> </span></span><br></pre></td></tr></table></figure>
<h4 id="onScopeDispose"><a href="#onScopeDispose" class="headerlink" title="onScopeDispose"></a>onScopeDispose</h4><p>在当前活跃的 <a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/api/effect-scope.html#effectscope">effect 作用域</a>上注册一个处理回调。该回调会在相关的 effect 作用域结束之后被调用，在VCA（Vue Composition API）函数中可用作<code>onUnmounted</code>的非组件替代品，区别在于其工作在scope中而不是组件实例</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前 effectScope 结束后调用</span></span><br><span class="line">onScopeDispose(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">window</span>.removeEventListener(<span class="string">&#x27;mousemove&#x27;</span>, handler)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>那么如此抽象的<code>effectScope</code>在尤大降低心智负担的主张下为什么要被提出呢，下面列了个官方rfc中的例子</p>
<p><strong>示例</strong></p>
<p>在vue的rfc中<a target="_blank" rel="noopener" href="https://github.com/vuejs/rfcs/blob/master/active-rfcs/0041-reactivity-effect-scope.md">reactivity-effect-scope</a>有这样的一个例子，如果有个监控鼠标位置的hook（useMouse），需要监听<code>mousemove</code>事件，如果在多个组件调用了这个hook，而内部是通过在<code>onUnmounted</code>钩子来移除<code>mousemove</code>监听器，<code>onUnmounted</code>耦合在每个组件实例，则无法以更有效率的方式共享这个<code>mousemove</code>监听器（即）</p>
<p>为了做到在组件间共享<code>useMouse</code>的响应式effect和监听器，可以创建一个函数来管理scope如下（这个hook也在vueuse中）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSharedComposable</span>(<span class="params">composable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> subscribers = <span class="number">0</span> <span class="comment">// 订阅计数器，每次调用subscribers + 1</span></span><br><span class="line">  <span class="keyword">let</span> state, scope</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispose = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (scope &amp;&amp; --subscribers &lt;= <span class="number">0</span>) &#123; </span><br><span class="line">      scope.stop()</span><br><span class="line">      state = scope = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    subscribers++</span><br><span class="line">    <span class="keyword">if</span> (!state) &#123; <span class="comment">// 只在第一次创建effectScope</span></span><br><span class="line">      scope = effectScope(<span class="literal">true</span>) <span class="comment">// true为独立的scope作用域</span></span><br><span class="line">      state = scope.run(<span class="function">() =&gt;</span> composable(...args))</span><br><span class="line">    &#125;</span><br><span class="line">    onScopeDispose(dispose) <span class="comment">// 在当前活跃的effect作用域上注册一个回调</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到dispose函数的含义是，当<strong>没有一个组件在使用</strong>它的时候会注销(dispose)创建的<code>effectScope</code>，我们只需要如下操作，即可得到一个<strong>在所有组件共享</strong>的<code>useMouse</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useSharedMouse = createSharedComposable(useMouse)</span><br></pre></td></tr></table></figure>
<p>更加详细的关于<code>effectScope</code>的讨论在<a target="_blank" rel="noopener" href="https://github.com/vuejs/rfcs/pull/212">Reactivity’s <code>effectScope</code> API #212</a></p>
<p>本来是打算<strong>完全</strong>按照官网的分类进行解读，但是由于VCA（Vue Composition API）的思想，hook被拆的很碎再组合在一起，并不能单纯靠分类进行解读，所以在讲某个分类的hook时也会带上其他的hooks，接下来是对我觉得 常用 或者 有学习到东西 的hook源码进行解读 </p>
<h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><h3 id="createGlobalState"><a href="#createGlobalState" class="headerlink" title="createGlobalState"></a>createGlobalState</h3><blockquote>
<p>用来做挂组件公共状态管理</p>
</blockquote>
<p>简单的单例模式实现，<code>effectScope</code>的参数为true时，其不会被父scope收集和回收，独立存在</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createGlobalState</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  stateFactory: () =&gt; T,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">CreateGlobalStateReturn</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> initialized = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> state: T</span><br><span class="line">  <span class="keyword">const</span> scope = effectScope(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">      state = scope.run(stateFactory)!</span><br><span class="line">      initialized = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useLocalStorage"><a href="#useLocalStorage" class="headerlink" title="useLocalStorage"></a>useLocalStorage</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useLocalStorage</span>&lt;<span class="title">T</span> <span class="title">extends</span>(<span class="params"><span class="built_in">string</span>|<span class="built_in">number</span>|<span class="built_in">boolean</span>|<span class="built_in">object</span>|<span class="literal">null</span></span>)&gt; (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  key: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  initialValue: MaybeRef&lt;T&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  options: StorageOptions&lt;T&gt; = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">RemovableRef</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="built_in">window</span> = defaultWindow &#125; = options</span><br><span class="line">  <span class="keyword">return</span> useStorage(key, initialValue, <span class="built_in">window</span>?.localStorage, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到就是用<code>useStorage</code>来实现的，<code>useSessionStorage</code>也是一样，下面我们来看看<code>useStorage</code></p>
<h3 id="useStorage"><a href="#useStorage" class="headerlink" title="useStorage"></a>useStorage</h3><p>在浏览器默认的Storage之上像<a target="_blank" rel="noopener" href="https://github.com/marcuswestin/store.js">store.js</a>一样对数据进行预处理（序列化），否则如果存一个对象在浏览器的Storage存的会是<code>xxx.toString()</code>之后的值。但是<code>useStorage</code>比起<a target="_blank" rel="noopener" href="https://github.com/marcuswestin/store.js">store.js</a>更进一步的增加了对<code>Map</code>和<code>Set</code>类型的数据的处理（<strong><code>Map</code>和<code>Set</code>存在默认的Storage和store.js都是空对象</strong>）</p>
<p>利用适配器模式，对每种数据类型定义<code>read</code>、<code>write</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> StorageSerializers: Record&lt;<span class="string">&#x27;boolean&#x27;</span> | <span class="string">&#x27;object&#x27;</span> | <span class="string">&#x27;number&#x27;</span> | <span class="string">&#x27;any&#x27;</span> | <span class="string">&#x27;string&#x27;</span> | <span class="string">&#x27;map&#x27;</span> | <span class="string">&#x27;set&#x27;</span>, Serializer&lt;<span class="built_in">any</span>&gt;&gt; = &#123;</span><br><span class="line">  <span class="attr">boolean</span>: &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> v === <span class="string">&#x27;true&#x27;</span>,</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">String</span>(v),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">object</span>: &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.parse(v),</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.stringify(v),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">number</span>: &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">Number</span>.parseFloat(v),</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">String</span>(v),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">any</span>: &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> v,</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">String</span>(v),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">string</span>: &#123;</span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> v,</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">String</span>(v),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">map</span>: &#123; <span class="comment">// map序列化</span></span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Map</span>(<span class="built_in">JSON</span>.parse(v)),</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.from((v <span class="keyword">as</span> <span class="built_in">Map</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;).entries())),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">set</span>: &#123; <span class="comment">// set序列化</span></span><br><span class="line">    <span class="attr">read</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">new</span> <span class="built_in">Set</span>(<span class="built_in">JSON</span>.parse(v)),</span><br><span class="line">    <span class="attr">write</span>: <span class="function">(<span class="params">v: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">JSON</span>.stringify(<span class="built_in">Array</span>.from((v <span class="keyword">as</span> <span class="built_in">Set</span>&lt;<span class="built_in">any</span>&gt;).entries())),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来判断用户传入的数据类型，进行选择对应的<code>read</code>、<code>write</code>方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">guessSerializerType</span>&lt;<span class="title">T</span> <span class="title">extends</span>(<span class="params"><span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span> | <span class="built_in">object</span> | <span class="literal">null</span></span>)&gt;(<span class="params">rawInit: T</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> rawInit == <span class="literal">null</span></span><br><span class="line">    ? <span class="string">&#x27;any&#x27;</span></span><br><span class="line">    : rawInit <span class="keyword">instanceof</span> <span class="built_in">Set</span></span><br><span class="line">      ? <span class="string">&#x27;set&#x27;</span></span><br><span class="line">      : rawInit <span class="keyword">instanceof</span> <span class="built_in">Map</span></span><br><span class="line">        ? <span class="string">&#x27;map&#x27;</span></span><br><span class="line">        : rawInit <span class="keyword">instanceof</span> <span class="built_in">Date</span></span><br><span class="line">          ? <span class="string">&#x27;date&#x27;</span></span><br><span class="line">          : <span class="keyword">typeof</span> rawInit === <span class="string">&#x27;boolean&#x27;</span></span><br><span class="line">            ? <span class="string">&#x27;boolean&#x27;</span></span><br><span class="line">            : <span class="keyword">typeof</span> rawInit === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">              ? <span class="string">&#x27;string&#x27;</span></span><br><span class="line">              : <span class="keyword">typeof</span> rawInit === <span class="string">&#x27;object&#x27;</span></span><br><span class="line">                ? <span class="string">&#x27;object&#x27;</span></span><br><span class="line">                : !<span class="built_in">Number</span>.isNaN(rawInit)</span><br><span class="line">                    ? <span class="string">&#x27;number&#x27;</span></span><br><span class="line">                    : <span class="string">&#x27;any&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">type</span> = guessSerializerType&lt;T&gt;(rawInit)</span><br><span class="line"><span class="keyword">const</span> serializer = options.serializer ?? StorageSerializers[<span class="keyword">type</span>] <span class="comment">// 用户还可以定义自己的序列化方法，但必须具有read和write方法</span></span><br></pre></td></tr></table></figure>
<p>下面是对数据的初始化</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> rawInit: T = unref(initialValue) <span class="comment">// 用户传入的初始值</span></span><br><span class="line"><span class="keyword">const</span> data = (shallow ? shallowRef : ref)(initialValue) <span class="keyword">as</span> Ref&lt;T&gt; <span class="comment">// 用户可以配置是浅响应式还是深，最后会返回给用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!storage)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> rawValue = storage.getItem(key)</span><br><span class="line">    <span class="keyword">if</span> (rawValue == <span class="literal">null</span>) &#123; <span class="comment">// 如果key对应的值为空，那么是首次</span></span><br><span class="line">        data.value = rawInit <span class="comment">// 初始化值</span></span><br><span class="line">        <span class="keyword">if</span> (writeDefaults &amp;&amp; rawInit !== <span class="literal">null</span>) <span class="comment">// 用户可配置（writeDefaults）是否首次存入Storage</span></span><br><span class="line">            storage.setItem(key, serializer.write(rawInit))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        data.value = serializer.read(rawValue) <span class="comment">// 如果Storage存在对应值，序列化读取</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    onError(e) <span class="comment">// 用户传入的错误处理函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是<strong>根据监听data的变化存入Storage</strong>，<code>watchWithFilter</code>可以看做是新增了<code>eventFilter</code>选项的<code>watch</code>，在后文会描述，也是vueuse很重要的一个特性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">watchWithFilter(</span><br><span class="line">    data,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.value == <span class="literal">null</span>)</span><br><span class="line">                storage.removeItem(key)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                storage.setItem(key, serializer.write(data.value))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            onError(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        flush, <span class="comment">// 均是用户可配置的选项</span></span><br><span class="line">        deep,</span><br><span class="line">        eventFilter,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>是不是觉得很OK了，但仍有巨隐蔽的bug（哈哈哈)，为了支持响应式的存取Storage，用了ref类型的data，<strong>在同源下的多个标签的情况下，其中一个页面对另一个页面用<code>useStorage</code>修改了数据，但另一个页面useStorage内部的data还是原来的值</strong></p>
<p>解决方式：监听<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/StorageEvent">storage</a>事件（当页面使用的storage被其他页面修改时会触发）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">event?: StorageEvent</span>) </span>&#123; <span class="comment">// 将上面初始化值的逻辑封装为read函数</span></span><br><span class="line">    <span class="keyword">if</span> (!storage || (event &amp;&amp; event.key !== key))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> rawValue = event ? event.newValue : storage.getItem(key)</span><br><span class="line">		<span class="comment">// 读值省略...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        onError(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span> &amp;&amp; listenToStorageChanges) <span class="comment">// 用户也可以配置（listenToStorageChanges）不监听</span></span><br><span class="line">    useEventListener(<span class="built_in">window</span>, <span class="string">&#x27;storage&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> read(e), <span class="number">0</span>)) <span class="comment">// 重新读取值给data</span></span><br></pre></td></tr></table></figure>
<h2 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h2><blockquote>
<p>浏览器相关的hook，基于web暴露的api来实现</p>
</blockquote>
<h3 id="可配置全局对象"><a href="#可配置全局对象" class="headerlink" title="可配置全局对象"></a>可配置全局对象</h3><p>Browser hook的源码开头都有或类似下面这一段</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> defaultWindow = <span class="comment">/* #__PURE__ */</span> isClient ? <span class="built_in">window</span> : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useXXX</span>&lt;<span class="title">T</span>&gt;(<span class="params">options: ConfigurableWindow = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="built_in">window</span> = defaultWindow &#125; = options</span><br><span class="line">  <span class="built_in">window</span>.xxx</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户可以配置当前window对象，这种配置方式对于使用<strong>iframe</strong>和<strong>测试环境</strong>不同的window对象十分有用</p>
<h3 id="useEventListener"><a href="#useEventListener" class="headerlink" title="useEventListener"></a>useEventListener</h3><p>先上一个简易版本的<code>useEventListener</code>，利用VCA，将事件的监听和注销放在一个函数中处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEventListener</span> (<span class="params">target, listener, options, target = <span class="built_in">window</span></span>) </span>&#123;</span><br><span class="line">  onMounted(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    target.addEventListener(type, listener, options)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  onUnmounted(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    target.removeEventListener(type, listener, options)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除此之外，源码还提供了当<code>target</code>的类型是<code>ref</code>时的情况，为了减少篇幅，下面的代码删减了参数为空的边界情况</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useEventListener</span>(<span class="params">...args: <span class="built_in">any</span>[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> target: MaybeRef&lt;EventTarget&gt; | <span class="literal">undefined</span> = defaultWindow;</span><br><span class="line">  <span class="keyword">let</span> event: <span class="built_in">string</span></span><br><span class="line">  <span class="keyword">let</span> listener: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> options: <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">  [target, event, listener, options] = args</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> cleanup = noop</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stopWatch = watch(</span><br><span class="line">    <span class="function">() =&gt;</span> unref(target),</span><br><span class="line">    <span class="function">(<span class="params">el</span>) =&gt;</span> &#123;</span><br><span class="line">      cleanup()</span><br><span class="line">      <span class="keyword">if</span> (!el)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      el.addEventListener(event, listener, options)</span><br><span class="line"></span><br><span class="line">      cleanup = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        el.removeEventListener(event, listener, options)</span><br><span class="line">        cleanup = noop</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">immediate</span>: <span class="literal">true</span>, <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span> &#125;, <span class="comment">// 为什么flush是post？下面会讲解</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    stopWatch()</span><br><span class="line">    cleanup()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryOnScopeDispose(stop)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 还设计了返回stop函数，可以调用useEventListener返回的函数直接回收</span></span><br><span class="line">  <span class="keyword">return</span> stop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="为什么需要支持ref-target"><a href="#为什么需要支持ref-target" class="headerlink" title="为什么需要支持ref target"></a>为什么需要支持ref target</h4><p>用<code>unref</code>得到<code>ref</code>中的dom元素，监听dom元素的改变以重新监听事件，应用场景就放官网例子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;cond&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Div1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span> <span class="attr">ref</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Div2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEventListener &#125; <span class="keyword">from</span> <span class="string">&#x27;@vueuse/core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> element = ref&lt;HTMLDivElement&gt;()</span><br><span class="line">useEventListener(element, <span class="string">&#x27;keydown&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123; <span class="built_in">console</span>.log(e.key) &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="为什么需要watch设置flush为post"><a href="#为什么需要watch设置flush为post" class="headerlink" title="为什么需要watch设置flush为post"></a>为什么需要watch设置flush为post</h4><p>详情请看<a target="_blank" rel="noopener" href="https://github.com/vueuse/vueuse/issues/356">#356 Bug: useEventListener doesn’t work correctly with v-if</a>，意思就是<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/issues/1706#issuecomment-666258948%5C">新版vue</a>的<code>watch</code>默认在所有组件update前执行，那么ref没有更新导致事件没有更新，所以需要在组件update完毕后更新事件。</p>
<h4 id="tryOnScopeDispose是啥"><a href="#tryOnScopeDispose是啥" class="headerlink" title="tryOnScopeDispose是啥"></a>tryOnScopeDispose是啥</h4><p>先判断是否有活跃的effectScope，有的话用<code>onScopeDispose</code>在其上注册fn回调</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">tryOnScopeDispose</span>(<span class="params">fn: Fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (getCurrentScope()) &#123;</span><br><span class="line">    onScopeDispose(fn)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>v10.4.1更新：支持event传递数组，方便浏览器兼容事件</p>
<h3 id="useEyeDropper"><a href="#useEyeDropper" class="headerlink" title="useEyeDropper"></a>useEyeDropper</h3><p><code>new window.EyeDropper()</code>可以获取<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/EyeDropper"><strong>取色器</strong></a>的功能</p>
<h3 id="usePreferredReducedMotion"><a href="#usePreferredReducedMotion" class="headerlink" title="usePreferredReducedMotion"></a>usePreferredReducedMotion</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-reduced-motion">prefers-reduced-motion</a>用于检测用户的系统是否被开启了动画减弱功能</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useMediaQuery(<span class="string">&#x27;(prefers-reduced-motion: reduce)&#x27;</span>, options)</span><br></pre></td></tr></table></figure>
<h3 id="usePreferredContrast"><a href="#usePreferredContrast" class="headerlink" title="usePreferredContrast"></a>usePreferredContrast</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-contrast">prefers-contrast</a>判断用户喜欢何种对比度（more、less、custom）</p>
<h3 id="useMediaQuery"><a href="#useMediaQuery" class="headerlink" title="useMediaQuery"></a>useMediaQuery</h3><p><code>window.matchMedia(query)</code>返回<code>MediaQueryList</code>类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> MediaQueryList <span class="keyword">extends</span> EventTarget &#123; <span class="comment">// 浏览器原生类型</span></span><br><span class="line">    <span class="keyword">readonly</span> matches: <span class="built_in">boolean</span>; <span class="comment">// 是否匹配</span></span><br><span class="line">    <span class="keyword">readonly</span> media: <span class="built_in">string</span>;    <span class="comment">// 媒体查询值</span></span><br><span class="line">    onchange: (<span class="function">(<span class="params"><span class="built_in">this</span>: MediaQueryList, ev: MediaQueryListEvent</span>) =&gt;</span> <span class="built_in">any</span>) | <span class="literal">null</span>; <span class="comment">// 媒体查询改变回调</span></span><br><span class="line">	<span class="comment">// 事件绑定相关...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mql: MediaQueryList = <span class="built_in">window</span>.matchMedia(<span class="string">&#x27;(max-width: 600px)&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="usePermission"><a href="#usePermission" class="headerlink" title="usePermission"></a>usePermission</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/permissions">navigator.permissions</a>可以获取用户权限（摄像头、麦克风等）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSupported = <span class="built_in">Boolean</span>(navigator &amp;&amp; <span class="string">&#x27;permissions&#x27;</span> <span class="keyword">in</span> navigator)</span><br><span class="line"><span class="keyword">const</span> state = ref&lt;PermissionState | <span class="literal">undefined</span>&gt;() <span class="comment">// 存权限状态</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onChange = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (permissionStatus)</span><br><span class="line">        state.value = permissionStatus.state</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    permissionStatus = <span class="keyword">await</span> navigator!.permissions.query(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;camera&#x27;</span> <span class="comment">// https://w3c.github.io/permissions/#enumdef-permissionname</span></span><br><span class="line">    &#125;)</span><br><span class="line">    useEventListener(permissionStatus, <span class="string">&#x27;change&#x27;</span>, onChange) <span class="comment">// 有三个状态 denied&quot; | &quot;granted&quot; | &quot;prompt&quot;</span></span><br><span class="line">    onChange()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> &#123;</span><br><span class="line">    state.value = <span class="string">&#x27;prompt&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="usePreferredLanguages"><a href="#usePreferredLanguages" class="headerlink" title="usePreferredLanguages"></a>usePreferredLanguages</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/languages">navigator.languages</a>可以获取用户的偏好语言，可以通过<code>languagechange</code>事件监听改变</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = ref&lt;<span class="keyword">readonly</span> <span class="built_in">string</span>[]&gt;(navigator.languages)</span><br><span class="line"></span><br><span class="line">useEventListener(<span class="built_in">window</span>, <span class="string">&#x27;languagechange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    value.value = navigator.languages</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="useShare"><a href="#useShare" class="headerlink" title="useShare"></a>useShare</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/share">navigator.share</a>可以进行分享</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSupported = navigator &amp;&amp; <span class="string">&#x27;canShare&#x27;</span> <span class="keyword">in</span> navigator</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isSupported) &#123;</span><br><span class="line">    granted = navigator.canShare(&#123; <span class="comment">// 判断是否能被分享</span></span><br><span class="line">        title?: <span class="built_in">string</span></span><br><span class="line">        files?: File[]</span><br><span class="line">        text?: <span class="built_in">string</span></span><br><span class="line">        url?: <span class="built_in">string</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (granted)</span><br><span class="line">        <span class="keyword">return</span> navigator.share!(data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useWakeLock"><a href="#useWakeLock" class="headerlink" title="useWakeLock"></a>useWakeLock</h3><p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API">Screen Wake Lock API</a>可以阻止设备变暗或锁屏</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSupported = navigator &amp;&amp; <span class="string">&#x27;wakeLock&#x27;</span> <span class="keyword">in</span> navigator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params"><span class="keyword">type</span>: WakeLockType</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSupported) <span class="keyword">return</span></span><br><span class="line">    wakeLock = <span class="keyword">await</span> navigator.wakeLock.request(<span class="keyword">type</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">release</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSupported || !wakeLock) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">await</span> wakeLock.release() <span class="comment">// 释放WakeLockSentinel</span></span><br><span class="line">    wakeLock = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useVibrate"><a href="#useVibrate" class="headerlink" title="useVibrate"></a>useVibrate</h3><p> <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Vibration_API">Vibration API</a>可以使设备振动</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.navigator.vibrate([<span class="number">200</span>, <span class="number">100</span>, <span class="number">200</span>]); <span class="comment">// 设备振动 200 ms，然后暂停 100 ms，然后再次振动设备 200 ms</span></span><br><span class="line">navigator.vibrate(<span class="number">0</span>); <span class="comment">// 停止振动</span></span><br></pre></td></tr></table></figure>
<h3 id="useWebNotification"><a href="#useWebNotification" class="headerlink" title="useWebNotification"></a>useWebNotification</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/notification">Notification</a>可以给用户发送消息</p>
<h3 id="useFullscreen"><a href="#useFullscreen" class="headerlink" title="useFullscreen"></a>useFullscreen</h3><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fullscreen_API">Fullscreen_API</a>用以控制全屏展示，虽然常见，但是看源码对兼容性有了多一层考虑</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求全屏</span></span><br><span class="line"><span class="keyword">const</span> requestMethod = computed&lt;<span class="string">&#x27;requestFullscreen&#x27;</span> | <span class="literal">undefined</span>&gt;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;requestFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitRequestFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitEnterFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitEnterFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitRequestFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mozRequestFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;msRequestFullscreen&#x27;</span>,</span><br><span class="line">  ].find(<span class="function"><span class="params">m</span> =&gt;</span> (<span class="built_in">document</span> &amp;&amp; m <span class="keyword">in</span> <span class="built_in">document</span>) || (targetRef.value &amp;&amp; m <span class="keyword">in</span> targetRef.value)) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 退出全屏</span></span><br><span class="line"><span class="keyword">const</span> exitMethod = computed&lt;<span class="string">&#x27;exitFullscreen&#x27;</span> | <span class="literal">undefined</span>&gt;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;exitFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitExitFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitExitFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitCancelFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mozCancelFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;msExitFullscreen&#x27;</span>,</span><br><span class="line">  ].find(<span class="function"><span class="params">m</span> =&gt;</span> (<span class="built_in">document</span> &amp;&amp; m <span class="keyword">in</span> <span class="built_in">document</span>) || (targetRef.value &amp;&amp; m <span class="keyword">in</span> targetRef.value)) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前是否处于全屏状态的判断</span></span><br><span class="line"><span class="keyword">const</span> fullscreenEnabled = computed&lt;<span class="string">&#x27;fullscreenEnabled&#x27;</span> | <span class="literal">undefined</span>&gt;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;fullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitIsFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;webkitDisplayingFullscreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mozFullScreen&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;msFullscreenElement&#x27;</span>,</span><br><span class="line">  ].find(<span class="function"><span class="params">m</span> =&gt;</span> (<span class="built_in">document</span> &amp;&amp; m <span class="keyword">in</span> <span class="built_in">document</span>) || (targetRef.value &amp;&amp; m <span class="keyword">in</span> targetRef.value)) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前全屏元素的方法名</span></span><br><span class="line"><span class="keyword">const</span> fullscreenElementMethod = [</span><br><span class="line">  <span class="string">&#x27;fullscreenElement&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;webkitFullscreenElement&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;mozFullScreenElement&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;msFullscreenElement&#x27;</span>,</span><br><span class="line">].find(<span class="function"><span class="params">m</span> =&gt;</span> (<span class="built_in">document</span> &amp;&amp; m <span class="keyword">in</span> <span class="built_in">document</span>)) <span class="keyword">as</span> <span class="string">&#x27;fullscreenElement&#x27;</span> | <span class="literal">undefined</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>利用适配器的方式进行调用，<code>target[requestMethod.value]()</code></p>
<p>下面是不同浏览器监听全局变化的事件名</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> eventHandlers = [</span><br><span class="line">  <span class="string">&#x27;fullscreenchange&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;webkitfullscreenchange&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;webkitendfullscreen&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;mozfullscreenchange&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;MSFullscreenChange&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// useEventListener支持传数组</span></span><br><span class="line">useEventListener(<span class="function">() =&gt;</span> unrefElement(targetRef), eventHandlers, handlerCallback, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Sensors"><a href="#Sensors" class="headerlink" title="Sensors"></a>Sensors</h2><h3 id="onStartTyping"><a href="#onStartTyping" class="headerlink" title="onStartTyping"></a>onStartTyping</h3><p>在开始输入的时候执行，我们可以拿来做到<strong>不管编辑器是否聚焦，只要输入就聚焦到编辑器并输入</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">onStartTyping</span>(<span class="params">callback: (event: KeyboardEvent) =&gt; <span class="built_in">void</span>, options: ConfigurableDocument = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="built_in">document</span> = defaultDocument &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keydown = <span class="function">(<span class="params">event: KeyboardEvent</span>) =&gt;</span> &#123;</span><br><span class="line">      isTypedCharValid(event) <span class="comment">// 检测是否是有效输入 0...9 A...Z a...z</span></span><br><span class="line">      &amp;&amp; callback(event)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">document</span>)</span><br><span class="line">    useEventListener(<span class="built_in">document</span>, <span class="string">&#x27;keydown&#x27;</span>, keydown, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的基础上还需要做一点，如果已经聚焦到<code>non-editable elements</code>，那么就不执行，如何检测<code>non-editable elements</code>呢，如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isFocusedElementEditable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; activeElement, body &#125; = <span class="built_in">document</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!activeElement)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (activeElement === body)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (activeElement.tagName) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INPUT&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;TEXTAREA&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> activeElement.hasAttribute(<span class="string">&#x27;contenteditable&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useMagicKeys"><a href="#useMagicKeys" class="headerlink" title="useMagicKeys"></a>useMagicKeys</h3><p>恰如其名，<strong>magic</strong>，先上用法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; space, shift &#125; = useMagicKeys()</span><br><span class="line"></span><br><span class="line">watch(space, <span class="function">(<span class="params">v</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (v)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;space has been pressed&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>又没传参，他怎么监听到我要的<code>space</code>和<code>shift</code>，难不成他返回了所有键？那当然不是，上源码（抽离了关键逻辑）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useMagicKeys</span>(<span class="params">options: UseMagicKeysOptions&lt;<span class="built_in">boolean</span>&gt; = &#123;&#125;</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = reactive(<span class="keyword">new</span> <span class="built_in">Set</span>&lt;<span class="built_in">string</span>&gt;())</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="function"><span class="title">toJSON</span>(<span class="params"></span>)</span> &#123; <span class="keyword">return</span> &#123;&#125; &#125;,</span><br><span class="line">    current,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> refs: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = useReactive ? reactive(obj) : obj</span><br><span class="line">  </span><br><span class="line">  useEventListener(target, <span class="string">&#x27;keydown&#x27;</span>, <span class="function">(<span class="params">e: KeyboardEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    updateRefs(e, <span class="literal">true</span>) <span class="comment">// 更新按下的键到refs，键为e.key?.toLowerCase()，值为true</span></span><br><span class="line">  &#125;, &#123; passive &#125;)</span><br><span class="line">    </span><br><span class="line">  useEventListener(target, <span class="string">&#x27;keyup&#x27;</span>, <span class="function">(<span class="params">e: KeyboardEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    updateRefs(e, <span class="literal">false</span>) <span class="comment">// 更新按下的键到refs，键为e.key?.toLowerCase()，值为false</span></span><br><span class="line">  &#125;, &#123; passive &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">    refs,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">get</span>(<span class="params">target, prop, rec</span>)</span> &#123;</span><br><span class="line">          </span><br><span class="line">        <span class="keyword">if</span> (!(prop <span class="keyword">in</span> refs)) &#123;</span><br><span class="line">          <span class="comment">// 初始将对应的键设为false，如&#x27;shift&#x27;</span></span><br><span class="line">          refs[prop] = ref(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> r = <span class="built_in">Reflect</span>.get(target, prop, rec)</span><br><span class="line">        <span class="keyword">return</span> useReactive ? toValue(r) : r</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> proxy <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样refs只存了取的键的状态，而不是所有键的状态</p>
<h3 id="usePageLeave"><a href="#usePageLeave" class="headerlink" title="usePageLeave"></a>usePageLeave</h3><p>用<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/MouseEvent/relatedTarget">MouseEvent.relatedTarget</a>检测是否离开屏幕</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">usePageLeave</span>(<span class="params">options: ConfigurableWindow = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> handler = <span class="function">(<span class="params">event: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">from</span> = event.relatedTarget || event.toElement <span class="comment">// 如果为null，则移出屏幕</span></span><br><span class="line">    isLeft.value = !<span class="keyword">from</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>) &#123;</span><br><span class="line">    useEventListener(<span class="built_in">window</span>, <span class="string">&#x27;mouseout&#x27;</span>, handler, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    useEventListener(<span class="built_in">window</span>.document, <span class="string">&#x27;mouseleave&#x27;</span>, handler, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    useEventListener(<span class="built_in">window</span>.document, <span class="string">&#x27;mouseenter&#x27;</span>, handler, &#123; <span class="attr">passive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isLeft</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="useSpeechSynthesis"><a href="#useSpeechSynthesis" class="headerlink" title="useSpeechSynthesis"></a>useSpeechSynthesis</h3><p>利用<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis">SpeechSynthesis</a>来做到语音阅读</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useSpeechSynthesis</span>(<span class="params">text: MaybeRefOrGetter&lt;<span class="built_in">string</span>&gt;, options: UseSpeechSynthesisOptions = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> synth = <span class="built_in">window</span> &amp;&amp; (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).speechSynthesis <span class="keyword">as</span> SpeechSynthesis;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">const</span> bindEventsForUtterance = <span class="function">(<span class="params">utterance: SpeechSynthesisUtterance</span>) =&gt;</span> &#123;</span><br><span class="line">    utterance.lang = toValue(lang)</span><br><span class="line">    utterance.voice = toValue(options.voice) || <span class="literal">null</span></span><br><span class="line">    utterance.pitch = toValue(pitch)</span><br><span class="line">    utterance.rate = toValue(rate)</span><br><span class="line">    utterance.volume = volume</span><br><span class="line"></span><br><span class="line">    utterance.onstart = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isPlaying.value = <span class="literal">true</span></span><br><span class="line">      status.value = <span class="string">&#x27;play&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    utterance.onpause = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isPlaying.value = <span class="literal">false</span></span><br><span class="line">      status.value = <span class="string">&#x27;pause&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    utterance.onresume = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isPlaying.value = <span class="literal">true</span></span><br><span class="line">      status.value = <span class="string">&#x27;play&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    utterance.onend = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      isPlaying.value = <span class="literal">false</span></span><br><span class="line">      status.value = <span class="string">&#x27;end&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    utterance.onerror = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      error.value = event</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> utterance = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    isPlaying.value = <span class="literal">false</span></span><br><span class="line">    status.value = <span class="string">&#x27;init&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> newUtterance = <span class="keyword">new</span> SpeechSynthesisUtterance(spokenText.value)</span><br><span class="line">    bindEventsForUtterance(newUtterance)</span><br><span class="line">    <span class="keyword">return</span> newUtterance</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> speak = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    synth!.cancel()</span><br><span class="line">    utterance &amp;&amp; synth!.speak(utterance.value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stop = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    synth!.cancel()</span><br><span class="line">    isPlaying.value = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryOnScopeDispose(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    isPlaying.value = <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h2><h3 id="useTransition"><a href="#useTransition" class="headerlink" title="useTransition"></a>useTransition</h3><p><strong>可配置项</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CubicBezierPoints = [<span class="built_in">number</span>, <span class="built_in">number</span>, <span class="built_in">number</span>, <span class="built_in">number</span>]</span><br><span class="line"><span class="keyword">type</span> EasingFunction = <span class="function">(<span class="params">n: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useTransition</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  source: Ref&lt;<span class="built_in">number</span> | <span class="built_in">number</span>[]&gt; | MaybeRef&lt;<span class="built_in">number</span>&gt;[],</span></span></span><br><span class="line"><span class="params"><span class="function">  options: TransitionOptions = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ComputedRef</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="comment">// 时间相关单位均为ms</span></span><br><span class="line">    delay = <span class="number">0</span>,           <span class="comment">// delay 后执行</span></span><br><span class="line">    disabled = <span class="literal">false</span>,    <span class="comment">// 是否关闭</span></span><br><span class="line">    duration = <span class="number">1000</span>,     <span class="comment">// 持续时间</span></span><br><span class="line">    onFinished = noop,   <span class="comment">// 完成后执行</span></span><br><span class="line">    onStarted = noop,    <span class="comment">// 开始时执行</span></span><br><span class="line">    transition = linear, <span class="comment">// 转化算法 MaybeRef&lt;EasingFunction | CubicBezierPoints&gt;，默认值是 x =&gt; x</span></span><br><span class="line">  &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>预处理</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useTransition</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  source: Ref&lt;<span class="built_in">number</span> | <span class="built_in">number</span>[]&gt; | MaybeRef&lt;<span class="built_in">number</span>&gt;[],</span></span></span><br><span class="line"><span class="params"><span class="function">  options: TransitionOptions = &#123;&#125;,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">ComputedRef</span>&lt;<span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 可配置项</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建当前的过渡函数，如果用户自定义了过渡函数则不做处理，否则根据贝赛尔曲线值创建过渡函数</span></span><br><span class="line">  <span class="keyword">const</span> currentTransition = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> t = unref(transition)</span><br><span class="line">    <span class="keyword">return</span> isFunction(t) ? t : createEasingFunction(t)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用unref处理source参数，如果source是数组则依次unref</span></span><br><span class="line">  <span class="keyword">const</span> sourceValue = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = unref&lt;<span class="built_in">number</span> | MaybeRef&lt;<span class="built_in">number</span>&gt;[]&gt;(source)</span><br><span class="line">    <span class="keyword">return</span> isNumber(s) ? s : s.map(unref) <span class="keyword">as</span> <span class="built_in">number</span>[]</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 规格化source，整成数组</span></span><br><span class="line">  <span class="keyword">const</span> sourceVector = computed(<span class="function">() =&gt;</span> isNumber(sourceValue.value) ? [sourceValue.value] : sourceValue.value)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建过渡函数，纯数学</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createEasingFunction</span>(<span class="params">[p0, p1, p2, p3]: CubicBezierPoints</span>): <span class="title">EasingFunction</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="function">(<span class="params">a1: <span class="built_in">number</span>, a2: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">1</span> - <span class="number">3</span> * a2 + <span class="number">3</span> * a1</span><br><span class="line">  <span class="keyword">const</span> b = <span class="function">(<span class="params">a1: <span class="built_in">number</span>, a2: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">3</span> * a2 - <span class="number">6</span> * a1</span><br><span class="line">  <span class="keyword">const</span> c = <span class="function">(<span class="params">a1: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">3</span> * a1</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> calcBezier = <span class="function">(<span class="params">t: <span class="built_in">number</span>, a1: <span class="built_in">number</span>, a2: <span class="built_in">number</span></span>) =&gt;</span> ((a(a1, a2) * t + b(a1, a2)) * t + c(a1)) * t</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getSlope = <span class="function">(<span class="params">t: <span class="built_in">number</span>, a1: <span class="built_in">number</span>, a2: <span class="built_in">number</span></span>) =&gt;</span> <span class="number">3</span> * a(a1, a2) * t * t + <span class="number">2</span> * b(a1, a2) * t + c(a1)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getTforX = <span class="function">(<span class="params">x: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> aGuessT = x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">      <span class="keyword">const</span> currentSlope = getSlope(aGuessT, p0, p2)</span><br><span class="line">      <span class="keyword">if</span> (currentSlope === <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> aGuessT</span><br><span class="line">      <span class="keyword">const</span> currentX = calcBezier(aGuessT, p0, p2) - x</span><br><span class="line">      aGuessT -= currentX / currentSlope</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> aGuessT</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">x: <span class="built_in">number</span></span>) =&gt;</span> p0 === p1 &amp;&amp; p2 === p3 ? x : calcBezier(getTforX(x), p1, p3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提供了几种过渡预设</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> TransitionPresets: Record&lt;<span class="built_in">string</span>, CubicBezierPoints | EasingFunction&gt; = &#123;</span><br><span class="line">  <span class="attr">easeInSine</span>: [<span class="number">0.12</span>, <span class="number">0</span>, <span class="number">0.39</span>, <span class="number">0</span>],</span><br><span class="line">  <span class="attr">easeOutSine</span>: [<span class="number">0.61</span>, <span class="number">1</span>, <span class="number">0.88</span>, <span class="number">1</span>],</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详情可以看 <a target="_blank" rel="noopener" href="https://easings.net/cn#">缓动函数</a>、 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/CSS/easing-function#easing_functions">MDN：缓动函数</a></p>
<p><strong>关键逻辑</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> outputVector = ref(sourceVector.value.slice(<span class="number">0</span>)) <span class="comment">// 用以存储输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过渡主流程，可以暂停</span></span><br><span class="line"><span class="keyword">const</span> &#123; resume, pause &#125; = useRafFn(<span class="function">() =&gt;</span> &#123; <span class="comment">// 可以暂停、恢复的 requestAnimationFrame</span></span><br><span class="line">  <span class="keyword">const</span> now = <span class="built_in">Date</span>.now()</span><br><span class="line">  <span class="keyword">const</span> progress = clamp(<span class="number">1</span> - ((endAt - now) / currentDuration), <span class="number">0</span>, <span class="number">1</span>) <span class="comment">// 过渡进度，clamp将值限制在0-1之间</span></span><br><span class="line"></span><br><span class="line">  outputVector.value = startVector.map(<span class="function">(<span class="params">val, i</span>) =&gt;</span> val + ((diffVector[i] ?? <span class="number">0</span>) * currentTransition.value(progress))) <span class="comment">// 更新output</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (progress &gt;= <span class="number">1</span>) &#123; <span class="comment">// 完成过渡</span></span><br><span class="line">    pause() <span class="comment">// 暂停 requestAnimationFrame</span></span><br><span class="line">    onFinished() <span class="comment">// 执行options中的完成回调</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123; <span class="attr">immediate</span>: <span class="literal">false</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeout = useTimeoutFn(start, delay, &#123; <span class="attr">immediate</span>: <span class="literal">false</span> &#125;) <span class="comment">// delay毫秒后执行start函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> start = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  pause() <span class="comment">// 暂停 过渡</span></span><br><span class="line"></span><br><span class="line">  currentDuration = unref(duration)</span><br><span class="line">  diffVector = outputVector.value.map(<span class="function">(<span class="params">n, i</span>) =&gt;</span> (sourceVector.value[i] ?? <span class="number">0</span>) - (outputVector.value[i] ?? <span class="number">0</span>)) <span class="comment">// 初始值和当前值的diff</span></span><br><span class="line">  startVector = outputVector.value.slice(<span class="number">0</span>) <span class="comment">// 拷贝初始值</span></span><br><span class="line">  startAt = <span class="built_in">Date</span>.now() <span class="comment">// 开始时间</span></span><br><span class="line">  endAt = startAt + currentDuration <span class="comment">// 结束时间，用在计算progress</span></span><br><span class="line"></span><br><span class="line">  resume() <span class="comment">// 开始过渡</span></span><br><span class="line">  onStarted() <span class="comment">// 执行options中的开始回调</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">watch(sourceVector, <span class="function">() =&gt;</span> &#123; <span class="comment">// 监听sourceVector的变化</span></span><br><span class="line">  <span class="keyword">if</span> (unref(disabled)) &#123; <span class="comment">// 如果暂停过渡，将输出还原回初始值</span></span><br><span class="line">    outputVector.value = sourceVector.value.slice(<span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (unref(delay) &lt;= <span class="number">0</span>) start() <span class="comment">// 如果没有延迟，则开始过渡</span></span><br><span class="line">    <span class="keyword">else</span> timeout.start() <span class="comment">// 如果有延迟，则开始上面创建好的timeout</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123; <span class="attr">deep</span>: <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> targetVector = unref(disabled) ? sourceVector : outputVector <span class="comment">// 如果暂停过渡，将输出还原回初始值</span></span><br><span class="line">  <span class="keyword">return</span> isNumber(sourceValue.value) ? targetVector.value[<span class="number">0</span>] : targetVector.value <span class="comment">// 为值解开数组包装，数组原样返回</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Sound"><a href="#Sound" class="headerlink" title="@Sound"></a>@Sound</h2><p>可以简单的让你的网站带上声音</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> buttonSfx <span class="keyword">from</span> <span class="string">&#x27;../assets/sounds/button.mp3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; play &#125; = useSound(buttonSfx)</span><br></pre></td></tr></table></figure>
<p>demo：<a target="_blank" rel="noopener" href="https://sound.vueuse.org/">https://sound.vueuse.org/</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Vueuse源码解读</p><p><a href="https://liang5757.github.io/2023/09/10/Js/源码解读/Vueuse源码解读/">https://liang5757.github.io/2023/09/10/Js/源码解读/Vueuse源码解读/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Liang</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-09-10</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-09-10</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/js/">js </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/10/06/Js/npm-script/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">npm script</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/04/19/Js/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/p-limit-%E9%99%90%E5%88%B6%E5%B9%B6%E5%8F%91%E6%95%B0/"><span class="level-item">【源码解读】p-limit 限制并发数</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="SOHUCS" sid="2023/09/10/Js/源码解读/Vueuse源码解读/"></div><script charset="utf-8" src="https://changyan.sohu.com/upload/changyan.js"></script><script>window.changyan.api.config({appid: 'cyvPeQjDi',conf: 'prod_4423b2f156eaea470ca4247bc48505a9'});</script></div></div></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen  order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#项目架构"><span class="level-left"><span class="level-item">项目架构</span></span></a></li><li><a class="level is-mobile" href="#前置知识"><span class="level-left"><span class="level-item">前置知识</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#unref-ref的反操作"><span class="level-left"><span class="level-item">unref - ref的反操作</span></span></a></li><li><a class="level is-mobile" href="#MaybeRef类型"><span class="level-left"><span class="level-item">MaybeRef类型</span></span></a></li><li><a class="level is-mobile" href="#Effect作用域API"><span class="level-left"><span class="level-item">Effect作用域API</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#effectScope"><span class="level-left"><span class="level-item">effectScope</span></span></a></li><li><a class="level is-mobile" href="#getCurrentScope"><span class="level-left"><span class="level-item">getCurrentScope</span></span></a></li><li><a class="level is-mobile" href="#onScopeDispose"><span class="level-left"><span class="level-item">onScopeDispose</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#State"><span class="level-left"><span class="level-item">State</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#createGlobalState"><span class="level-left"><span class="level-item">createGlobalState</span></span></a></li><li><a class="level is-mobile" href="#useLocalStorage"><span class="level-left"><span class="level-item">useLocalStorage</span></span></a></li><li><a class="level is-mobile" href="#useStorage"><span class="level-left"><span class="level-item">useStorage</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Browser"><span class="level-left"><span class="level-item">Browser</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#可配置全局对象"><span class="level-left"><span class="level-item">可配置全局对象</span></span></a></li><li><a class="level is-mobile" href="#useEventListener"><span class="level-left"><span class="level-item">useEventListener</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#为什么需要支持ref-target"><span class="level-left"><span class="level-item">为什么需要支持ref target</span></span></a></li><li><a class="level is-mobile" href="#为什么需要watch设置flush为post"><span class="level-left"><span class="level-item">为什么需要watch设置flush为post</span></span></a></li><li><a class="level is-mobile" href="#tryOnScopeDispose是啥"><span class="level-left"><span class="level-item">tryOnScopeDispose是啥</span></span></a></li></ul></li><li><a class="level is-mobile" href="#useEyeDropper"><span class="level-left"><span class="level-item">useEyeDropper</span></span></a></li><li><a class="level is-mobile" href="#usePreferredReducedMotion"><span class="level-left"><span class="level-item">usePreferredReducedMotion</span></span></a></li><li><a class="level is-mobile" href="#usePreferredContrast"><span class="level-left"><span class="level-item">usePreferredContrast</span></span></a></li><li><a class="level is-mobile" href="#useMediaQuery"><span class="level-left"><span class="level-item">useMediaQuery</span></span></a></li><li><a class="level is-mobile" href="#usePermission"><span class="level-left"><span class="level-item">usePermission</span></span></a></li><li><a class="level is-mobile" href="#usePreferredLanguages"><span class="level-left"><span class="level-item">usePreferredLanguages</span></span></a></li><li><a class="level is-mobile" href="#useShare"><span class="level-left"><span class="level-item">useShare</span></span></a></li><li><a class="level is-mobile" href="#useWakeLock"><span class="level-left"><span class="level-item">useWakeLock</span></span></a></li><li><a class="level is-mobile" href="#useVibrate"><span class="level-left"><span class="level-item">useVibrate</span></span></a></li><li><a class="level is-mobile" href="#useWebNotification"><span class="level-left"><span class="level-item">useWebNotification</span></span></a></li><li><a class="level is-mobile" href="#useFullscreen"><span class="level-left"><span class="level-item">useFullscreen</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Sensors"><span class="level-left"><span class="level-item">Sensors</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#onStartTyping"><span class="level-left"><span class="level-item">onStartTyping</span></span></a></li><li><a class="level is-mobile" href="#useMagicKeys"><span class="level-left"><span class="level-item">useMagicKeys</span></span></a></li><li><a class="level is-mobile" href="#usePageLeave"><span class="level-left"><span class="level-item">usePageLeave</span></span></a></li><li><a class="level is-mobile" href="#useSpeechSynthesis"><span class="level-left"><span class="level-item">useSpeechSynthesis</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Animation"><span class="level-left"><span class="level-item">Animation</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#useTransition"><span class="level-left"><span class="level-item">useTransition</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Sound"><span class="level-left"><span class="level-item">@Sound</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Liang的个人博客</a><p class="is-size-7"><span>&copy; 2023 Liang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Liang5757"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>